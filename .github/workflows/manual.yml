name: Auto-Deploy Minecraft Server

on:
  push:
    branches:
      - main

jobs:
  deploy-to-awx:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create or Update AWX Project
        run: |
          echo "ðŸ”§ Checking or creating AWX Project..."
          curl -s -X POST "${{ secrets.AWX_URL }}/api/v2/projects/" \
          -H "Content-Type: application/json" \
          -u "${{ secrets.AWX_USER }}:${{ secrets.AWX_PASS }}" \
          -d '{
            "name": "Minecraft_Deploy_Project",
            "scm_type": "git",
            "scm_url": "https://github.com/0gulcandogann/deploy_game_server_for_aws.git",
            "scm_branch": "main",
            "scm_update_on_launch": true
          }' || echo "Project already exists or updated."

      - name: Create or Update AWX Inventory
        run: |
          echo "ðŸ“¦ Checking or creating AWX Inventory..."
          curl -s -X POST "${{ secrets.AWX_URL }}/api/v2/inventories/" \
          -H "Content-Type: application/json" \
          -u "${{ secrets.AWX_USER }}:${{ secrets.AWX_PASS }}" \
          -d '{
            "name": "Minecraft_Inventory",
            "organization": 1
          }' || echo "Inventory already exists or updated."

      - name: Create AWX Credential (AWS)
        run: |
          echo "ðŸ”‘ Creating AWX AWS credential..."
          curl -s -X POST "${{ secrets.AWX_URL }}/api/v2/credentials/" \
          -H "Content-Type: application/json" \
          -u "${{ secrets.AWX_USER }}:${{ secrets.AWX_PASS }}" \
          -d '{
            "name": "AWS_Credentials",
            "credential_type": 8,
            "organization": 1,
            "inputs": {
              "username": "${{ secrets.AWS_ACCESS_KEY_ID }}",
              "password": "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
            }
          }' || echo "Credential already exists or updated."

      - name: Create or Update AWX Job Template
        run: |
          echo "ðŸ§± Creating or updating AWX Job Template..."
          curl -s -X POST "${{ secrets.AWX_URL }}/api/v2/job_templates/" \
          -H "Content-Type: application/json" \
          -u "${{ secrets.AWX_USER }}:${{ secrets.AWX_PASS }}" \
          -d '{
            "name": "Deploy_Minecraft_Server",
            "job_type": "run",
            "inventory": 1,
            "project": 1,
            "playbook": "deploy_minecraft.yml",
            "credential": 1,
            "become_enabled": true
          }' || echo "Template already exists or updated."

      - name: Launch AWX Job Template
        run: |
          echo "ðŸš€ Launching AWX Job Template..."
          curl -s -X POST "${{ secrets.AWX_URL }}/api/v2/job_templates/1/launch/" \
          -u "${{ secrets.AWX_USER }}:${{ secrets.AWX_PASS }}"
